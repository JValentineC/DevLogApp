generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextIndex"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  
  // Name fields
  firstName    String   @db.VarChar(100)
  middleName   String?  @db.VarChar(100)
  lastName     String   @db.VarChar(100)
  
  // Authentication
  email            String    @unique @db.VarChar(255)
  password         String    @db.VarChar(255)
  passwordHint     String?   @db.VarChar(255)
  resetToken       String?   @db.VarChar(255)
  resetTokenExpiry DateTime?
  
  // Profile
  username         String    @unique @db.VarChar(50)
  role             String    @default("user") @db.VarChar(20) // 'user', 'admin', 'super_admin'
  profilePhoto     String?   @db.VarChar(500)
  avatarShape      String?   @default("rounded") @db.VarChar(50)
  bio              String?   @db.Text
  linkedInUrl      String?   @db.VarChar(500)
  portfolioUrl     String?   @db.VarChar(500)
  githubUrl        String?   @db.VarChar(500)
  
  // UI Settings
  theme            String?   @default("light") @db.VarChar(20)
  profileVisibility String?  @default("public") // enum in DB
  showBioPublic    Boolean?  @default(true) @db.TinyInt
  
  // Notification settings
  emailNotifications Boolean? @default(true) @db.TinyInt
  weeklyDigest       Boolean? @default(true) @db.TinyInt
  marketingEmails    Boolean? @default(false) @db.TinyInt
  
  // 2FA
  twoFactorEnabled   Boolean?  @default(false) @db.TinyInt
  twoFactorSecret    String?   @db.VarChar(255)
  backupCodes        String?   @db.Text
  twoFactorEnabledAt DateTime?
  
  // Tracking
  lastLoginAt      DateTime?
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  devLogs              DevLog[]
  person               Person?  // Optional link to Person table
  reactions            Reaction[]
  comments             Comment[]
  bookmarks            Bookmark[]
  followersRelation    Follow[] @relation("Following")
  followingRelation    Follow[] @relation("Follower")
  notificationsReceived Notification[] @relation("NotificationUser")
  notificationsActed   Notification[] @relation("NotificationActor")
  notificationPrefs    NotificationPreference?
  activities           Activity[]
  projects             Project[]
  teamMemberships      TeamMember[]
  teamsOwned           Team[]
  leaderboard          Leaderboard?
  achievements         UserAchievement[]
  auditLogs            AuditLog[]
  
  @@index([email])
  @@index([role])
  @@index([theme])
  @@index([profileVisibility])
  @@index([twoFactorEnabled])
  @@index([lastLoginAt])
  @@index([resetToken])
  @@map("User")
}

model Person {
  id              Int       @id @default(autoincrement())
  userId          Int?      @unique
  
  // Name fields
  firstName       String    @db.VarChar(100)
  middleName      String?   @db.VarChar(100)
  lastName        String    @db.VarChar(100)
  fullName        String    @db.VarChar(255) // Computed/stored in application
  
  // Email fields
  orgEmail        String?   @unique @db.VarChar(255) // Must end with @icstars.org when present
  personalEmail   String?   @unique @db.VarChar(255)
  
  // Contact & Links
  phone           String?   @db.VarChar(50)
  linkedInUrl     String?   @db.VarChar(500)
  portfolioUrl    String?   @db.VarChar(500)
  githubUrl       String?   @db.VarChar(500)
  
  // iCAA Membership convenience flags (synced from ICaaMembership)
  isICaaMember    Boolean   @default(false) @db.TinyInt
  icaaTier        String?   @db.VarChar(20) // 'free','monthly','yearly','lifetime'
  
  // Account status
  accountStatus   String    @default("unclaimed") @db.VarChar(20) // 'unclaimed','invited','signed_up','deactivated'
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  user                User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  cycleMemberships    CycleMembership[]
  captainAssignments  CaptainAssignment[]
  icaaMemberships     ICaaMembership[]
  resumes             Resume[]
  jobSeekingProfile   JobSeekingProfile?
  
  @@index([lastName])
  @@index([accountStatus])
  @@map("Person")
}

model Cycle {
  id         Int       @id @default(autoincrement())
  code       String    @unique @db.VarChar(50) // e.g., "CHI-50", "Cycle 50"
  city       String?   @db.VarChar(100)
  startDate  DateTime? @db.Date
  endDate    DateTime? @db.Date
  notes      String?   @db.Text
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  
  // Relations
  cycleMemberships    CycleMembership[]
  captainAssignments  CaptainAssignment[]
  teams               Team[]
  
  @@map("Cycle")
}

model CycleMembership {
  id         Int       @id @default(autoincrement())
  cycleId    Int
  personId   Int
  startDate  DateTime? @db.Date
  endDate    DateTime? @db.Date
  status     String    @default("active") @db.VarChar(20) // 'active','graduated','withdrawn','alumni'
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  
  // Relations
  cycle      Cycle     @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  person     Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  @@unique([cycleId, personId])
  @@index([cycleId])
  @@index([personId])
  @@index([status])
  @@map("CycleMembership")
}

model CaptainAssignment {
  id         Int       @id @default(autoincrement())
  cycleId    Int
  personId   Int
  role       String    @default("captain") @db.VarChar(20) // 'captain','co-captain','lead'
  startDate  DateTime? @db.Date
  endDate    DateTime? @db.Date
  notes      String?   @db.Text
  
  // Relations
  cycle      Cycle     @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  person     Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  @@unique([cycleId, personId, role, startDate])
  @@index([cycleId])
  @@index([personId])
  @@map("CaptainAssignment")
}

model ICaaMembership {
  id             Int       @id @default(autoincrement())
  personId       Int
  tier           String    @db.VarChar(20) // 'free','monthly','yearly','lifetime'
  status         String    @default("active") @db.VarChar(20) // 'active','cancelled','expired','lapsed'
  startDate      DateTime  @db.Date
  endDate        DateTime? @db.Date
  autoRenew      Boolean   @default(false) @db.TinyInt
  lastPaymentAt  DateTime?
  notes          String?   @db.Text
  
  // Relations
  person         Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  @@index([personId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("ICaaMembership")
}

model Resume {
  id              Int       @id @default(autoincrement())
  personId        Int
  versionLabel    String?   @db.VarChar(100) // e.g., "2025-12 Chicago"
  fileUrl         String?   @db.VarChar(1000)
  fileMimeType    String?   @db.VarChar(100)
  fileSizeBytes   BigInt?
  fileHashSha256  String?   @db.Char(64)
  fileBlob        Bytes?    @db.LongBlob
  isCurrent       Boolean   @default(false) @db.TinyInt
  uploadedAt      DateTime  @default(now())
  notes           String?   @db.Text
  
  // Relations
  person          Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  @@index([personId])
  @@index([isCurrent])
  @@map("Resume")
}

model JobSeekingProfile {
  id                   Int       @id @default(autoincrement())
  personId             Int       @unique
  desiredTitle         String    @db.VarChar(255) // e.g., "Junior Software Engineer"
  roleFamily           String    @default("other") @db.VarChar(20) // 'software','data','cloud','security','qa','devops','product','design','it-support','other'
  skillsSummary        String?   @db.Text
  skillsKeywords       Json?     // e.g., ["React","Node","SQL"]
  preferredLocations   Json?     // e.g., ["Chicago, IL","Remote"]
  remotePreference     String    @default("no-preference") @db.VarChar(20) // 'remote','hybrid','onsite','no-preference'
  availabilityDate     DateTime? @db.Date
  workAuthorization    String    @default("Prefer-not-to-say") @db.VarChar(30) // 'US-citizen','GC','EAD','H1B','Other','Prefer-not-to-say'
  desiredSalaryMin     Int?
  desiredSalaryMax     Int?
  openToContract       Boolean   @default(true) @db.TinyInt
  openToFullTime       Boolean   @default(true) @db.TinyInt
  jobSearchStatus      String    @default("active") @db.VarChar(20) // 'not-looking','casual','active','interviewing','offer-stage','accepted','on-hold'
  updatedAt            DateTime  @updatedAt
  
  // Relations
  person               Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  @@map("JobSeekingProfile")
}

model DevLog {
  id          Int       @id @default(autoincrement())
  title       String    @db.VarChar(255)
  content     String    @db.Text
  
  // User relationship
  createdBy   Int
  user        User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  
  // Image support (JSON array of URLs)
  images      String?   @db.Text
  
  // Publishing
  isPublished Boolean   @default(false) @db.TinyInt
  
  // Soft delete
  deletedAt   DateTime?
  
  // Timestamps
  createdAt   DateTime  @default(now()) @db.DateTime
  updatedAt   DateTime  @updatedAt @db.DateTime
  
  // Relations
  devLogTags        DevLogTag[]
  reactions         Reaction[]
  comments          Comment[]
  bookmarks         Bookmark[]
  engagementMetrics EngagementMetrics?
  projectLinks      ProjectDevLog[]
  
  @@index([createdBy])
  @@index([createdAt])
  @@index([isPublished])
  @@index([createdBy, createdAt], name: "idx_devlog_user_created")
  @@fulltext([title, content])
  @@map("DevLog")
}

model Tag {
  id          Int         @id @default(autoincrement())
  name        String      @unique @db.VarChar(50)
  slug        String      @unique @db.VarChar(50)
  description String?     @db.Text
  color       String      @default("#6c757d") @db.VarChar(7)
  createdAt   DateTime    @default(now()) @db.DateTime
  updatedAt   DateTime    @updatedAt
  
  // Relations
  devLogTags  DevLogTag[]
  
  @@index([slug], name: "idx_tag_slug")
  @@map("Tag")
}

model DevLogTag {
  id       Int    @id @default(autoincrement())
  devLogId Int
  tagId    Int
  
  // Relations
  devLog   DevLog @relation(fields: [devLogId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([devLogId, tagId], name: "unique_devlog_tag")
  @@index([devLogId], name: "idx_devlog")
  @@index([tagId], name: "idx_tag")
  @@map("DevLogTag")
}

// ============================================================================
// PHASE 2: ENGAGEMENT & SOCIAL FEATURES
// ============================================================================

model Reaction {
  id        Int      @id @default(autoincrement())
  devLogId  Int
  userId    Int
  type      String   // enum in DB: 'like','celebrate','helpful','insightful'
  createdAt DateTime @default(now())
  
  // Relations
  devLog    DevLog   @relation(fields: [devLogId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, devLogId, type], name: "unique_user_devlog_reaction")
  @@index([devLogId], name: "idx_reaction_devlog")
  @@index([userId], name: "idx_reaction_user")
  @@map("Reaction")
}

model Comment {
  id        Int       @id @default(autoincrement())
  devLogId  Int
  userId    Int
  content   String    @db.Text
  parentId  Int?
  isEdited  Boolean?  @default(false) @db.TinyInt
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Relations
  devLog    DevLog    @relation(fields: [devLogId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  
  @@index([devLogId], name: "idx_comment_devlog")
  @@index([userId], name: "idx_comment_user")
  @@index([parentId], name: "idx_comment_parent")
  @@map("Comment")
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())
  
  // Relations
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId], name: "unique_follow")
  @@index([followerId], name: "idx_follow_follower")
  @@index([followingId], name: "idx_follow_following")
  @@map("Follow")
}

model Bookmark {
  id        Int      @id @default(autoincrement())
  userId    Int
  devLogId  Int
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  devLog    DevLog   @relation(fields: [devLogId], references: [id], onDelete: Cascade)
  
  @@unique([userId, devLogId], name: "unique_bookmark")
  @@index([userId], name: "idx_bookmark_user")
  @@index([devLogId])
  @@map("Bookmark")
}

// ============================================================================
// PHASE 3: ANALYTICS & TRACKING
// ============================================================================

model Activity {
  id           Int      @id @default(autoincrement())
  userId       Int?
  activityType String   // enum in DB: 'view','create','edit','delete','like','comment','share','login','logout'
  entityType   String   // enum in DB: 'devlog','comment','profile','user'
  entityId     Int?
  metadata     Json?
  ipAddress    String?  @db.VarChar(45)
  userAgent    String?  @db.Text
  createdAt    DateTime @default(now())
  
  // Relations
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId], name: "idx_activity_user")
  @@index([activityType], name: "idx_activity_type")
  @@index([entityType, entityId], name: "idx_activity_entity")
  @@index([createdAt], name: "idx_activity_created")
  @@map("Activity")
}

model EngagementMetrics {
  id                 Int      @id @default(autoincrement())
  devLogId           Int      @unique
  viewCount          Int?     @default(0)
  likeCount          Int?     @default(0)
  commentCount       Int?     @default(0)
  bookmarkCount      Int?     @default(0)
  shareCount         Int?     @default(0)
  avgReadTimeSeconds Int?
  lastUpdated        DateTime @default(now()) @updatedAt
  
  // Relations
  devLog             DevLog   @relation(fields: [devLogId], references: [id], onDelete: Cascade)
  
  @@index([devLogId], name: "idx_metrics_devlog")
  @@map("EngagementMetrics")
}

model ActivityArchive {
  id           Int      @id @default(autoincrement())
  userId       Int?
  activityType String   // enum in DB
  entityType   String   // enum in DB
  entityId     Int?
  metadata     Json?
  ipAddress    String?  @db.VarChar(45)
  userAgent    String?  @db.Text
  createdAt    DateTime @default(now())
  
  @@index([userId], name: "idx_activity_user")
  @@index([activityType], name: "idx_activity_type")
  @@index([entityType, entityId], name: "idx_activity_entity")
  @@index([createdAt], name: "idx_activity_created")
  @@map("ActivityArchive")
}

// ============================================================================
// PHASE 4: NOTIFICATIONS
// ============================================================================

model Notification {
  id         Int      @id @default(autoincrement())
  userId     Int
  actorId    Int?
  type       String   // enum in DB: 'comment','like','follow','mention','milestone','system'
  entityType String   // enum in DB: 'devlog','comment','user'
  entityId   Int?
  message    String   @db.Text
  isRead     Boolean? @default(false) @db.TinyInt
  createdAt  DateTime @default(now())
  
  // Relations
  user       User     @relation("NotificationUser", fields: [userId], references: [id], onDelete: Cascade)
  actor      User?    @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)
  
  @@index([userId], name: "idx_notification_user")
  @@index([actorId])
  @@index([isRead], name: "idx_notification_read")
  @@index([createdAt], name: "idx_notification_created")
  @@map("Notification")
}

model NotificationPreference {
  id             Int     @id @default(autoincrement())
  userId         Int     @unique
  emailOnComment Boolean? @default(true) @db.TinyInt
  emailOnLike    Boolean? @default(false) @db.TinyInt
  emailOnFollow  Boolean? @default(true) @db.TinyInt
  emailOnMention Boolean? @default(true) @db.TinyInt
  emailDigest    String?  @default("weekly") // enum in DB: 'none','daily','weekly'
  pushEnabled    Boolean? @default(true) @db.TinyInt
  
  // Relations
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("NotificationPreference")
}

// ============================================================================
// PHASE 5: GAMIFICATION
// ============================================================================

model Achievement {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(50)
  name        String   @db.VarChar(100)
  description String?  @db.Text
  iconUrl     String?  @db.VarChar(255)
  pointValue  Int?     @default(0)
  requirement Json?
  createdAt   DateTime @default(now())
  
  // Relations
  userAchievements UserAchievement[]
  
  @@map("Achievement")
}

model UserAchievement {
  id            Int      @id @default(autoincrement())
  userId        Int
  achievementId Int
  unlockedAt    DateTime @default(now())
  
  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId], name: "unique_user_achievement")
  @@index([userId], name: "idx_userachievement_user")
  @@index([achievementId])
  @@map("UserAchievement")
}

model Leaderboard {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique
  totalPoints      Int?     @default(0)
  devLogCount      Int?     @default(0)
  likeCount        Int?     @default(0)
  commentCount     Int?     @default(0)
  streak           Int?     @default(0)
  lastActivityDate DateTime? @db.Date
  rank             Int?
  updatedAt        DateTime @default(now()) @updatedAt
  
  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([totalPoints], name: "idx_leaderboard_points")
  @@index([rank], name: "idx_leaderboard_rank")
  @@map("Leaderboard")
}

// ============================================================================
// PHASE 6: PROJECTS & COLLABORATION
// ============================================================================

model Project {
  id           Int      @id @default(autoincrement())
  userId       Int
  title        String   @db.VarChar(200)
  description  String?  @db.Text
  status       String?  @default("planning") // enum in DB: 'planning','in_progress','completed','paused'
  startDate    DateTime? @db.Date
  endDate      DateTime? @db.Date
  githubUrl    String?  @db.VarChar(255)
  liveUrl      String?  @db.VarChar(255)
  thumbnailUrl String?  @db.VarChar(255)
  visibility   String?  @default("public") // enum in DB: 'public','private','cycle_only'
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  devLogs      ProjectDevLog[]
  
  @@index([userId], name: "idx_project_user")
  @@index([status], name: "idx_project_status")
  @@map("Project")
}

model ProjectDevLog {
  id        Int      @id @default(autoincrement())
  projectId Int
  devLogId  Int
  createdAt DateTime @default(now())
  
  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  devLog    DevLog   @relation(fields: [devLogId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, devLogId], name: "unique_project_devlog")
  @@index([devLogId])
  @@map("ProjectDevLog")
}

model Team {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  cycleId     Int?
  ownerId     Int
  visibility  String?  @default("private") // enum in DB: 'public','private','cycle_only'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  cycle       Cycle?       @relation(fields: [cycleId], references: [id], onDelete: SetNull)
  owner       User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members     TeamMember[]
  
  @@index([cycleId], name: "idx_team_cycle")
  @@index([ownerId])
  @@map("Team")
}

model TeamMember {
  id       Int      @id @default(autoincrement())
  teamId   Int
  userId   Int
  role     String?  @default("member") // enum in DB: 'owner','admin','member'
  joinedAt DateTime @default(now())
  
  // Relations
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId], name: "unique_team_member")
  @@index([userId])
  @@map("TeamMember")
}

// ============================================================================
// PHASE 7: SECURITY & AUDIT
// ============================================================================

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String   @db.VarChar(100)
  tableName String   @db.VarChar(50)
  recordId  Int?
  oldValues Json?
  newValues Json?
  ipAddress String?  @db.VarChar(45)
  createdAt DateTime @default(now())
  
  // Relations
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId], name: "idx_audit_user")
  @@index([tableName, recordId], name: "idx_audit_table")
  @@map("AuditLog")
}
